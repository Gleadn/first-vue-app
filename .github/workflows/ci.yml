name: CI - Lint, Tests et Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  MONGODB_VERSION: '6.0'

jobs:
  lint:
    name: Code Quality (Lint)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        cache-dependency-path: 'pnpm-lock.yaml'
    
    - name: Install workspace dependencies
      run: pnpm install
    
    - name: Install backend dependencies
      working-directory: ./server
      run: pnpm install
    
    - name: Install frontend dependencies  
      working-directory: ./client
      run: pnpm install
    
    - name: Lint backend code
      working-directory: ./server
      run: pnpm run lint
    
    - name: Lint frontend code
      working-directory: ./client
      run: pnpm run lint

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      mongodb:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
          MONGO_INITDB_DATABASE: restaurant_db
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        cache-dependency-path: 'server/pnpm-lock.yaml'
    
    - name: Install dependencies
      working-directory: ./server
      run: pnpm install
    
    - name: Wait for MongoDB
      run: |
        timeout 60 bash -c 'until nc -z localhost 27017; do sleep 1; done'
    
    - name: Run backend tests with coverage
      working-directory: ./server
      run: pnpm run test:coverage
      env:
        NODE_ENV: test
        MONGODB_URI: mongodb://admin:password@localhost:27017/restaurant_db_test?authSource=admin
        JWT_SECRET: test-jwt-secret-key-for-ci
    
    - name: Upload backend coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-coverage-report
        path: server/coverage/
        retention-days: 30

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        cache-dependency-path: 'client/pnpm-lock.yaml'
    
    - name: Install dependencies
      working-directory: ./client
      run: pnpm install
    
    - name: Run frontend tests with coverage
      working-directory: ./client
      run: pnpm run test:coverage
      env:
        NODE_ENV: test
    
    - name: Upload frontend coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-coverage-report
        path: client/coverage/
        retention-days: 30

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        cache-dependency-path: 'pnpm-lock.yaml'
    
    - name: Install workspace dependencies
      run: pnpm install
    
    - name: Build frontend application
      working-directory: ./client
      run: pnpm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: client/dist/
        retention-days: 30

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    
    - name: Install backend dependencies
      working-directory: ./server
      run: pnpm install
    
    - name: Run backend security audit
      working-directory: ./server
      run: pnpm audit --audit-level=moderate
      continue-on-error: true
    
    - name: Install frontend dependencies
      working-directory: ./client
      run: pnpm install
    
    - name: Run frontend security audit
      working-directory: ./client
      run: pnpm audit --audit-level=moderate
      continue-on-error: true

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [lint, test-backend, test-frontend, build]
    if: always()
    
    steps:
    - name: Notify success
      if: needs.lint.result == 'success' && needs.test-backend.result == 'success' && needs.test-frontend.result == 'success' && needs.build.result == 'success'
      run: |
        echo "CI Pipeline réussie !"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Tous les jobs ont été exécutés avec succès."
    
    - name: Notify failure
      if: needs.lint.result == 'failure' || needs.test-backend.result == 'failure' || needs.test-frontend.result == 'failure' || needs.build.result == 'failure'
      run: |
        echo "CI Pipeline échouée !"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Jobs en échec:"
        if [ "${{ needs.lint.result }}" == "failure" ]; then echo "  - Lint"; fi
        if [ "${{ needs.test-backend.result }}" == "failure" ]; then echo "  - Tests Backend"; fi
        if [ "${{ needs.test-frontend.result }}" == "failure" ]; then echo "  - Tests Frontend"; fi
        if [ "${{ needs.build.result }}" == "failure" ]; then echo "  - Build"; fi
        exit 1